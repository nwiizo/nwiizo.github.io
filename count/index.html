<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>文字数カウンター</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap');

    :root {
        --primary-color: #3498db;
        --secondary-color: #2ecc71;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --dark-color: #2c3e50;
        --light-bg: #f7f9fc;
        --card-bg: #ffffff;
        --text-primary: #2c3e50;
        --text-secondary: #7f8c8d;
        --border-color: #e0e6ed;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 6px 20px rgba(0, 0, 0, 0.12);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
        background-color: var(--light-bg);
        color: var(--text-primary);
        line-height: 1.6;
        padding: 20px;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: var(--card-bg);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 40px;
        transition: all 0.3s ease;
    }

    .container:hover {
        box-shadow: var(--shadow-hover);
    }

    .header {
        text-align: center;
        margin-bottom: 40px;
    }

    h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .subtitle {
        color: var(--text-secondary);
        font-size: 16px;
        font-weight: 400;
    }

    .toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
    }

    .toolbar-left {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .toolbar-right {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .mode-btn {
        padding: 8px 16px;
        font-size: 14px;
        border: 2px solid var(--border-color);
        background: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .mode-btn:hover {
        border-color: var(--primary-color);
        transform: translateY(-1px);
    }

    .mode-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .textarea-wrapper {
        position: relative;
        margin-bottom: 30px;
    }

    textarea {
        width: 100%;
        min-height: 400px;
        padding: 20px;
        border: 2px solid var(--border-color);
        border-radius: 12px;
        resize: vertical;
        font-size: 16px;
        font-family: 'Noto Sans JP', sans-serif;
        background-color: var(--card-bg);
        color: var(--text-primary);
        transition: all 0.3s ease;
        line-height: 1.8;
    }

    textarea:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }

    .character-limit-bar {
        position: absolute;
        bottom: -20px;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        overflow: hidden;
        display: none;
    }

    .character-limit-bar.show {
        display: block;
    }

    .character-limit-fill {
        height: 100%;
        background: var(--secondary-color);
        transition: all 0.3s ease;
        border-radius: 2px;
    }

    .character-limit-fill.warning {
        background: var(--warning-color);
    }

    .character-limit-fill.danger {
        background: var(--danger-color);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: var(--light-bg);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.1);
    }

    .stat-icon {
        font-size: 24px;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--primary-color);
        margin-bottom: 4px;
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
    }

    .advanced-stats {
        background: var(--light-bg);
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .advanced-stats-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .advanced-stats-title {
        font-size: 20px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .stats-table {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
    }

    .stat-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        background: white;
        border-radius: 8px;
        font-size: 14px;
    }

    .stat-item-label {
        color: var(--text-secondary);
    }

    .stat-item-value {
        font-weight: 600;
        color: var(--text-primary);
    }

    .word-frequency {
        background: var(--light-bg);
        padding: 30px;
        border-radius: 12px;
        margin-bottom: 30px;
    }

    .frequency-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
        max-height: 200px;
        overflow-y: auto;
    }

    .frequency-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 12px;
        background: white;
        border-radius: 6px;
        font-size: 13px;
    }

    .frequency-word {
        font-weight: 500;
        color: var(--text-primary);
    }

    .frequency-count {
        color: var(--primary-color);
        font-weight: 600;
    }

    .comparison-wrapper {
        margin-bottom: 30px;
    }

    .comparison-container {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }

    .comparison-panel {
        background: var(--light-bg);
        padding: 20px;
        border-radius: 12px;
        border: 2px solid var(--border-color);
    }

    .comparison-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 15px;
        text-align: center;
    }

    .comparison-textarea {
        width: 100%;
        min-height: 300px;
        padding: 15px;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        resize: vertical;
        font-size: 14px;
        font-family: 'Noto Sans JP', sans-serif;
        background-color: white;
        margin-bottom: 15px;
    }

    .comparison-textarea:focus {
        outline: none;
        border-color: var(--primary-color);
    }

    .comparison-stats {
        display: flex;
        justify-content: space-around;
        gap: 10px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .stat-mini strong {
        color: var(--primary-color);
        font-weight: 600;
    }

    .comparison-divider {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vs-label {
        background: var(--primary-color);
        color: white;
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 18px;
    }

    .comparison-results {
        background: var(--light-bg);
        padding: 30px;
        border-radius: 12px;
        text-align: center;
    }

    .comparison-results h3 {
        font-size: 20px;
        margin-bottom: 20px;
        color: var(--text-primary);
    }

    .comparison-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .comparison-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
    }

    .comparison-label {
        display: block;
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .comparison-value {
        display: block;
        font-size: 24px;
        font-weight: 700;
        color: var(--primary-color);
    }

    .action-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }

    .btn {
        padding: 12px 24px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Noto Sans JP', sans-serif;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background-color: var(--primary-color);
        color: white;
    }

    .btn-primary:hover {
        background-color: #2980b9;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
    }

    .btn-secondary {
        background-color: var(--secondary-color);
        color: white;
    }

    .btn-secondary:hover {
        background-color: #27ae60;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
    }

    .btn-outline {
        background-color: transparent;
        color: var(--text-primary);
        border: 2px solid var(--border-color);
    }

    .btn-outline:hover {
        border-color: var(--primary-color);
        color: var(--primary-color);
        transform: translateY(-2px);
    }

    .settings-panel {
        position: fixed;
        right: -400px;
        top: 0;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 1000;
        overflow-y: auto;
    }

    .settings-panel.open {
        right: 0;
    }

    .settings-header {
        padding: 30px;
        background: var(--primary-color);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .settings-content {
        padding: 30px;
    }

    .setting-group {
        margin-bottom: 25px;
    }

    .setting-group-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-primary);
    }

    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .setting-label {
        font-size: 14px;
        color: var(--text-secondary);
    }

    .toggle-switch {
        position: relative;
        width: 50px;
        height: 26px;
        background: var(--border-color);
        border-radius: 13px;
        cursor: pointer;
        transition: background 0.3s ease;
    }

    .toggle-switch.active {
        background: var(--primary-color);
    }

    .toggle-slider {
        position: absolute;
        top: 3px;
        left: 3px;
        width: 20px;
        height: 20px;
        background: white;
        border-radius: 50%;
        transition: left 0.3s ease;
    }

    .toggle-switch.active .toggle-slider {
        left: 27px;
    }

    .character-limit-input {
        width: 100px;
        padding: 8px;
        border: 2px solid var(--border-color);
        border-radius: 6px;
        text-align: center;
        font-size: 14px;
    }

    .export-options {
        display: grid;
        gap: 10px;
    }

    .export-btn {
        padding: 10px;
        background: var(--light-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        text-align: left;
    }

    .export-btn:hover {
        border-color: var(--primary-color);
        background: white;
    }

    .toast {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        padding: 16px 24px;
        background: var(--dark-color);
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1001;
        font-size: 14px;
    }

    .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .reading-time {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--text-secondary);
    }

    @media (max-width: 768px) {
        .container {
            padding: 20px;
        }
        
        h1 {
            font-size: 24px;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .settings-panel {
            width: 100%;
            right: -100%;
        }
        
        .comparison-container {
            grid-template-columns: 1fr;
        }
        
        .comparison-divider {
            margin: 20px 0;
        }
    }

    /* スクロールバーのスタイリング */
    ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    ::-webkit-scrollbar-track {
        background: var(--light-bg);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>
        <span>📊</span>
        文字数カウンター
      </h1>
      <p class="subtitle">高機能日本語対応 - リアルタイム解析・詳細統計</p>
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <button class="mode-btn active" data-mode="normal">
          <span>📝</span> 通常モード
        </button>
        <button class="mode-btn" data-mode="comparison">
          <span>🔄</span> 比較モード
        </button>
        <button class="mode-btn" data-mode="analysis">
          <span>📈</span> 詳細分析
        </button>
      </div>
      <div class="toolbar-right">
        <div class="reading-time">
          <span>⏱️</span>
          <span id="readingTime">読了時間: 0分</span>
        </div>
        <button class="btn btn-outline" id="settingsBtn">
          <span>⚙️</span> 設定
        </button>
      </div>
    </div>

    <div class="textarea-wrapper" id="normalMode">
      <textarea id="input" placeholder="ここに文章を入力してください...&#10;&#10;💡 ヒント:&#10;• Ctrl/Cmd + A で全選択&#10;• Ctrl/Cmd + Z で元に戻す&#10;• 文字数制限を設定で有効化できます"></textarea>
      <div class="character-limit-bar" id="limitBar">
        <div class="character-limit-fill" id="limitFill"></div>
      </div>
    </div>

    <div class="comparison-wrapper" id="comparisonMode" style="display: none;">
      <div class="comparison-container">
        <div class="comparison-panel">
          <h3 class="comparison-title">テキスト A</h3>
          <textarea id="inputA" class="comparison-textarea" placeholder="比較する1つ目のテキストを入力..."></textarea>
          <div class="comparison-stats">
            <span class="stat-mini">文字数: <strong id="charsA">0</strong></span>
            <span class="stat-mini">語数: <strong id="wordsA">0</strong></span>
            <span class="stat-mini">行数: <strong id="linesA">0</strong></span>
          </div>
        </div>
        <div class="comparison-divider">
          <div class="vs-label">VS</div>
        </div>
        <div class="comparison-panel">
          <h3 class="comparison-title">テキスト B</h3>
          <textarea id="inputB" class="comparison-textarea" placeholder="比較する2つ目のテキストを入力..."></textarea>
          <div class="comparison-stats">
            <span class="stat-mini">文字数: <strong id="charsB">0</strong></span>
            <span class="stat-mini">語数: <strong id="wordsB">0</strong></span>
            <span class="stat-mini">行数: <strong id="linesB">0</strong></span>
          </div>
        </div>
      </div>
      <div class="comparison-results" id="comparisonResults">
        <h3>📊 比較結果</h3>
        <div class="comparison-grid">
          <div class="comparison-item">
            <span class="comparison-label">文字数の差</span>
            <span class="comparison-value" id="charDiff">0</span>
          </div>
          <div class="comparison-item">
            <span class="comparison-label">語数の差</span>
            <span class="comparison-value" id="wordDiff">0</span>
          </div>
          <div class="comparison-item">
            <span class="comparison-label">共通語句</span>
            <span class="comparison-value" id="commonWords">0</span>
          </div>
          <div class="comparison-item">
            <span class="comparison-label">類似度</span>
            <span class="comparison-value" id="similarity">0%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">📝</div>
        <div class="stat-value" id="totalChars">0</div>
        <div class="stat-label">総文字数</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">🚫</div>
        <div class="stat-value" id="charsNoSpaces">0</div>
        <div class="stat-label">文字数（空白除く）</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">💬</div>
        <div class="stat-value" id="wordCount">0</div>
        <div class="stat-label">語数（推定）</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">📄</div>
        <div class="stat-value" id="lineCount">0</div>
        <div class="stat-label">行数</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">📑</div>
        <div class="stat-value" id="paragraphCount">0</div>
        <div class="stat-label">段落数</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">📖</div>
        <div class="stat-value" id="sentenceCount">0</div>
        <div class="stat-label">文数</div>
      </div>
    </div>

    <div class="advanced-stats" id="advancedStats" style="display: none;">
      <div class="advanced-stats-header">
        <h3 class="advanced-stats-title">📊 詳細統計</h3>
      </div>
      <div class="stats-table">
        <div class="stat-item">
          <span class="stat-item-label">ひらがな</span>
          <span class="stat-item-value" id="hiraganaCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">カタカナ</span>
          <span class="stat-item-value" id="katakanaCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">漢字</span>
          <span class="stat-item-value" id="kanjiCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">英数字</span>
          <span class="stat-item-value" id="alphanumericCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">記号</span>
          <span class="stat-item-value" id="symbolCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">絵文字</span>
          <span class="stat-item-value" id="emojiCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">URL数</span>
          <span class="stat-item-value" id="urlCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">メールアドレス数</span>
          <span class="stat-item-value" id="emailCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">文節数（推定）</span>
          <span class="stat-item-value" id="phraseCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">平均文長</span>
          <span class="stat-item-value" id="avgSentenceLength">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">最長語句</span>
          <span class="stat-item-value" id="longestWord">-</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">異なり語数</span>
          <span class="stat-item-value" id="uniqueWords">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-item-label">語彙の豊富さ</span>
          <span class="stat-item-value" id="lexicalDiversity">0%</span>
        </div>
      </div>
    </div>

    <div class="word-frequency" id="wordFrequency" style="display: none;">
      <div class="advanced-stats-header">
        <h3 class="advanced-stats-title">🔤 語句頻度（上位20件）</h3>
      </div>
      <div class="frequency-list" id="frequencyList"></div>
    </div>

    <div class="action-buttons">
      <button class="btn btn-secondary" id="copyBtn">
        <span>📋</span> コピー
      </button>
      <button class="btn btn-outline" id="exportBtn">
        <span>💾</span> エクスポート
      </button>
      <button class="btn btn-outline" id="resetBtn">
        <span>🔄</span> リセット
      </button>
    </div>
  </div>

  <div class="settings-panel" id="settingsPanel">
    <div class="settings-header">
      <h3>設定</h3>
      <button id="closeSettingsBtn" style="background: none; border: none; color: white; cursor: pointer; font-size: 24px;">&times;</button>
    </div>
    <div class="settings-content">
      <div class="setting-group">
        <div class="setting-group-title">表示設定</div>
        <div class="setting-item">
          <span class="setting-label">リアルタイム更新</span>
          <div class="toggle-switch active" id="realtimeToggle">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span class="setting-label">詳細統計を常に表示</span>
          <div class="toggle-switch" id="alwaysShowStats">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span class="setting-label">語句頻度を表示</span>
          <div class="toggle-switch" id="showWordFrequency">
            <div class="toggle-slider"></div>
          </div>
        </div>
      </div>

      <div class="setting-group">
        <div class="setting-group-title">文字数制限</div>
        <div class="setting-item">
          <span class="setting-label">文字数制限を有効化</span>
          <div class="toggle-switch" id="enableLimit">
            <div class="toggle-slider"></div>
          </div>
        </div>
        <div class="setting-item">
          <span class="setting-label">制限文字数</span>
          <input type="number" class="character-limit-input" id="charLimit" value="1000" min="1">
        </div>
      </div>

      <div class="setting-group">
        <div class="setting-group-title">読了時間設定</div>
        <div class="setting-item">
          <span class="setting-label">読書速度（文字/分）</span>
          <input type="number" class="character-limit-input" id="readingSpeed" value="500" min="100" max="1000">
        </div>
      </div>

      <div class="setting-group">
        <div class="setting-group-title">エクスポート</div>
        <div class="export-options">
          <button class="export-btn" id="exportTextBtn">
            <strong>📄 テキストファイル</strong><br>
            <small>統計情報付きのテキストファイル</small>
          </button>
          <button class="export-btn" id="exportJSONBtn">
            <strong>📊 JSON</strong><br>
            <small>プログラムで利用可能な形式</small>
          </button>
          <button class="export-btn" id="exportCSVBtn">
            <strong>📈 CSV</strong><br>
            <small>Excelで開ける形式</small>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // メインアプリケーションのクラス
    class CharacterCounter {
        constructor() {
            this.state = {
                mode: 'normal',
                settings: {
                    realtime: true,
                    alwaysShowStats: false,
                    showWordFrequency: false,
                    enableLimit: false,
                    charLimit: 1000,
                    readingSpeed: 500
                },
                lastAnalysis: null,
                comparisonData: {
                    textA: { chars: 0, words: 0, lines: 0 },
                    textB: { chars: 0, words: 0, lines: 0 }
                }
            };

            this.elements = {
                input: document.getElementById('input'),
                inputA: document.getElementById('inputA'),
                inputB: document.getElementById('inputB'),
                normalMode: document.getElementById('normalMode'),
                comparisonMode: document.getElementById('comparisonMode'),
                totalChars: document.getElementById('totalChars'),
                charsNoSpaces: document.getElementById('charsNoSpaces'),
                wordCount: document.getElementById('wordCount'),
                lineCount: document.getElementById('lineCount'),
                paragraphCount: document.getElementById('paragraphCount'),
                sentenceCount: document.getElementById('sentenceCount'),
                readingTime: document.getElementById('readingTime'),
                advancedStats: document.getElementById('advancedStats'),
                wordFrequency: document.getElementById('wordFrequency'),
                frequencyList: document.getElementById('frequencyList'),
                settingsPanel: document.getElementById('settingsPanel'),
                toast: document.getElementById('toast'),
                limitBar: document.getElementById('limitBar'),
                limitFill: document.getElementById('limitFill')
            };

            this.init();
        }

        init() {
            this.setupEventListeners();
            this.updateStats();
            this.showToast('文字数カウンターへようこそ！');
        }

        setupEventListeners() {
            // テキストエリアの入力イベント
            this.elements.input.addEventListener('input', () => {
                if (this.state.settings.realtime) {
                    this.updateStats();
                }
            });

            // 比較モードのテキストエリア
            if (this.elements.inputA && this.elements.inputB) {
                this.elements.inputA.addEventListener('input', () => {
                    if (this.state.settings.realtime) {
                        this.updateComparisonStats();
                    }
                });
                
                this.elements.inputB.addEventListener('input', () => {
                    if (this.state.settings.realtime) {
                        this.updateComparisonStats();
                    }
                });
            }

            // モードボタン
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.setMode(btn.getAttribute('data-mode'));
                });
            });

            // 設定ボタン
            document.getElementById('settingsBtn').addEventListener('click', () => {
                this.elements.settingsPanel.classList.add('open');
            });

            // 設定を閉じるボタン
            document.getElementById('closeSettingsBtn').addEventListener('click', () => {
                this.elements.settingsPanel.classList.remove('open');
            });

            // アクションボタン
            document.getElementById('copyBtn').addEventListener('click', () => {
                this.copyText();
            });
            document.getElementById('exportBtn').addEventListener('click', () => {
                this.exportAsText();
            });
            document.getElementById('resetBtn').addEventListener('click', () => {
                this.reset();
            });

            // エクスポートボタン
            document.getElementById('exportTextBtn').addEventListener('click', () => {
                this.exportAsText();
            });
            document.getElementById('exportJSONBtn').addEventListener('click', () => {
                this.exportAsJSON();
            });
            document.getElementById('exportCSVBtn').addEventListener('click', () => {
                this.exportAsCSV();
            });

            // 設定トグル
            this.setupSettingsToggles();

            // キーボードショートカット
            document.addEventListener('keydown', (e) => {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'Enter':
                            e.preventDefault();
                            this.updateStats();
                            this.showToast('統計を更新しました');
                            break;
                        case 'd':
                            e.preventDefault();
                            this.setMode('analysis');
                            break;
                    }
                }
            });
        }

        setupSettingsToggles() {
            document.getElementById('realtimeToggle').addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('active');
                this.state.settings.realtime = e.currentTarget.classList.contains('active');
                if (this.state.settings.realtime) {
                    this.updateStats();
                }
            });

            document.getElementById('alwaysShowStats').addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('active');
                this.state.settings.alwaysShowStats = e.currentTarget.classList.contains('active');
                this.elements.advancedStats.style.display = this.state.settings.alwaysShowStats ? 'block' : 'none';
                if (this.state.settings.alwaysShowStats) {
                    this.updateStats();
                }
            });

            document.getElementById('showWordFrequency').addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('active');
                this.state.settings.showWordFrequency = e.currentTarget.classList.contains('active');
                this.elements.wordFrequency.style.display = this.state.settings.showWordFrequency && 
                    (this.state.mode === 'analysis' || this.state.settings.alwaysShowStats) ? 'block' : 'none';
                if (this.state.settings.showWordFrequency) {
                    this.updateStats();
                }
            });

            document.getElementById('enableLimit').addEventListener('click', (e) => {
                e.currentTarget.classList.toggle('active');
                this.state.settings.enableLimit = e.currentTarget.classList.contains('active');
                this.updateStats();
            });

            document.getElementById('charLimit').addEventListener('change', (e) => {
                this.state.settings.charLimit = parseInt(e.target.value) || 1000;
                if (this.state.settings.enableLimit) {
                    this.updateStats();
                }
            });

            document.getElementById('readingSpeed').addEventListener('change', (e) => {
                this.state.settings.readingSpeed = parseInt(e.target.value) || 500;
                this.updateStats();
            });
        }

        // 日本語の形態素解析（簡易版）
        tokenizeJapanese(text) {
            const particles = /[がのをにへとでやかもはばてでもからまでよりほどなどだけしかさえすらこそなりたりなどへもけれどもけれどけどがしかししかもそれでもでもだがただしもっともちなみになおかつまたはあるいはおよびならびに]/g;
            
            const patterns = [
                /[\u30A0-\u30FF]+/g,  // カタカナ
                /[\u3040-\u309F]+/g,  // ひらがな
                /[\u4E00-\u9FAF]+/g,  // 漢字
                /[a-zA-Z]+/g,         // 英語
                /\d+/g                // 数字
            ];
            
            const tokens = [];
            patterns.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    matches.forEach(match => {
                        if (!particles.test(match) && match.length > 0) {
                            tokens.push(match);
                        }
                    });
                }
            });
            
            return tokens;
        }

        // 日本語の文節を推定
        estimateJapanesePhrases(text) {
            const phraseBreakers = [
                /[、。！？]/g,
                /[はがをにへとでやも]/g,
                /[するしたしてしない]/g,
                /[ですますでしたました]/g,
            ];
            
            let phraseCount = 1;
            phraseBreakers.forEach(pattern => {
                const matches = text.match(pattern);
                if (matches) {
                    phraseCount += matches.length;
                }
            });
            
            return Math.max(1, Math.floor(phraseCount / 2));
        }

        updateStats() {
            const text = this.elements.input.value;
            
            // 基本統計
            const totalChars = text.length;
            const charsNoSpaces = text.replace(/\s/g, '').length;
            
            // 日本語判定と語数計算
            const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(text);
            let words = [];
            let wordCount = 0;
            
            if (hasJapanese) {
                words = this.tokenizeJapanese(text);
                wordCount = words.length;
            } else {
                words = text.match(/\S+/g) || [];
                wordCount = words.length;
            }
            
            const lines = text ? text.split('\n').length : 0;
            const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim() !== '').length;
            const sentences = text.match(/[.!?。！？]+/g) || [];
            const sentenceCount = sentences.length || (text.trim() ? 1 : 0);
            
            // UI更新
            this.elements.totalChars.textContent = totalChars.toLocaleString();
            this.elements.charsNoSpaces.textContent = charsNoSpaces.toLocaleString();
            this.elements.wordCount.textContent = wordCount.toLocaleString();
            this.elements.lineCount.textContent = lines.toLocaleString();
            this.elements.paragraphCount.textContent = paragraphs.toLocaleString();
            this.elements.sentenceCount.textContent = sentenceCount.toLocaleString();
            
            // 読了時間
            let readingTime;
            if (hasJapanese) {
                readingTime = Math.ceil(totalChars / this.state.settings.readingSpeed);
            } else {
                readingTime = Math.ceil(wordCount / 200);
            }
            this.elements.readingTime.textContent = `読了時間: ${readingTime}分`;
            
            // 文字数制限
            if (this.state.settings.enableLimit) {
                this.elements.limitBar.classList.add('show');
                const percentage = (totalChars / this.state.settings.charLimit) * 100;
                this.elements.limitFill.style.width = Math.min(percentage, 100) + '%';
                
                this.elements.limitFill.classList.remove('warning', 'danger');
                if (percentage > 90) {
                    this.elements.limitFill.classList.add('danger');
                } else if (percentage > 70) {
                    this.elements.limitFill.classList.add('warning');
                }
            } else {
                this.elements.limitBar.classList.remove('show');
            }
            
            // 詳細統計
            if (this.state.settings.alwaysShowStats || this.state.mode === 'analysis') {
                this.updateAdvancedStats(text, words, hasJapanese);
            }
            
            // 分析結果を保存
            this.state.lastAnalysis = {
                text,
                totalChars,
                charsNoSpaces,
                wordCount,
                lines,
                paragraphs,
                sentenceCount,
                timestamp: new Date().toISOString()
            };
        }

        updateAdvancedStats(text, words, hasJapanese) {
            // 文字種別カウント
            const hiragana = (text.match(/[\u3040-\u309F]/g) || []).length;
            const katakana = (text.match(/[\u30A0-\u30FF]/g) || []).length;
            const kanji = (text.match(/[\u4E00-\u9FAF]/g) || []).length;
            const alphanumeric = (text.match(/[a-zA-Z0-9]/g) || []).length;
            const emoji = (text.match(/[\u{1F000}-\u{1F9FF}]|[\u{2600}-\u{26FF}]/gu) || []).length;
            
            // URL とメール
            const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_\+.~#?&//=]*)/g;
            const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g;
            const urls = (text.match(urlRegex) || []).length;
            const emails = (text.match(emailRegex) || []).length;
            
            // 記号
            const symbols = text.replace(/[\w\s\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/g, '').length;
            
            // 平均文長
            const sentences = text.split(/[.!?。！？]+/).filter(s => s.trim());
            const avgSentenceLength = sentences.length > 0 
                ? Math.round(sentences.reduce((sum, s) => sum + s.trim().length, 0) / sentences.length)
                : 0;
            
            // 最長語句
            const longestWord = words.reduce((longest, word) => 
                word.length > longest.length ? word : longest, '');
            
            // ユニーク語数と語彙の豊富さ
            const uniqueWords = new Set(words.map(w => w.toLowerCase()));
            const lexicalDiversity = words.length > 0 
                ? Math.round((uniqueWords.size / words.length) * 100) 
                : 0;
            
            // UI更新
            document.getElementById('hiraganaCount').textContent = hiragana.toLocaleString();
            document.getElementById('katakanaCount').textContent = katakana.toLocaleString();
            document.getElementById('kanjiCount').textContent = kanji.toLocaleString();
            document.getElementById('alphanumericCount').textContent = alphanumeric.toLocaleString();
            document.getElementById('symbolCount').textContent = symbols.toLocaleString();
            document.getElementById('emojiCount').textContent = emoji.toLocaleString();
            document.getElementById('urlCount').textContent = urls.toLocaleString();
            document.getElementById('emailCount').textContent = emails.toLocaleString();
            document.getElementById('avgSentenceLength').textContent = avgSentenceLength.toLocaleString();
            document.getElementById('longestWord').textContent = longestWord || '-';
            document.getElementById('uniqueWords').textContent = uniqueWords.size.toLocaleString();
            document.getElementById('lexicalDiversity').textContent = lexicalDiversity + '%';
            
            // 文節数（日本語のみ）
            if (hasJapanese) {
                const phraseCount = this.estimateJapanesePhrases(text);
                document.getElementById('phraseCount').textContent = phraseCount.toLocaleString();
            }
            
            // 語句頻度
            if (this.state.settings.showWordFrequency && words.length > 0) {
                this.updateWordFrequency(words);
            }
        }

        updateWordFrequency(words) {
            const frequency = {};
            const stopWords = new Set(['の', 'に', 'は', 'を', 'た', 'が', 'で', 'て', 'と', 'し', 'れ', 'さ', 'ある', 'いる', 'も', 'する', 'から', 'な', 'こと', 'として', 'い', 'や', 'など', 'なっ', 'ない', 'この', 'ため', 'その', 'あっ', 'よう', 'また', 'もの', 'という', 'あり', 'まで', 'られ', 'なる', 'へ', 'か', 'だ', 'これ', 'によって', 'により', 'おり', 'より', 'による', 'ず', 'なり', 'られる', 'において', 'ば', 'なかっ', 'なく', 'しかし', 'について', 'せ', 'だっ', 'その後', 'できる', 'それ', 'う', 'ので', 'なお', 'のみ', 'でき', 'き', 'つ', 'における', 'および', 'いう', 'さらに', 'でも', 'ら', 'たり', 'その他', 'に関する', 'たち', 'ます', 'ん', 'なら', 'に対して', '特に', 'せる', '及び', 'これら', 'とき', 'では', 'にて', 'ほか', 'ながら', 'うち', 'そして', 'とともに', 'ただし', 'かつて', 'それぞれ', 'または', 'お', 'ほど', 'さらには', 'なければ', 'さらに', 'について', 'いった']);
            
            words.forEach(word => {
                const normalized = word.toLowerCase().replace(/[.,!?;:'"]/g, '');
                if (normalized.length > 1 && !stopWords.has(normalized)) {
                    frequency[normalized] = (frequency[normalized] || 0) + 1;
                }
            });
            
            const sorted = Object.entries(frequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20);
            
            this.elements.frequencyList.innerHTML = sorted.map(([word, count]) => `
                <div class="frequency-item">
                    <span class="frequency-word">${word}</span>
                    <span class="frequency-count">${count}</span>
                </div>
            `).join('');
        }

        setMode(mode) {
            this.state.mode = mode;
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-mode') === mode);
            });
            
            // モードに応じて表示を切り替え
            if (mode === 'normal') {
                this.elements.normalMode.style.display = 'block';
                this.elements.comparisonMode.style.display = 'none';
                document.querySelector('.stats-grid').style.display = 'grid';
                this.elements.advancedStats.style.display = 'none';
                this.elements.wordFrequency.style.display = 'none';
                this.updateStats();
            } else if (mode === 'comparison') {
                this.elements.normalMode.style.display = 'none';
                this.elements.comparisonMode.style.display = 'block';
                document.querySelector('.stats-grid').style.display = 'none';
                this.elements.advancedStats.style.display = 'none';
                this.elements.wordFrequency.style.display = 'none';
                this.updateComparisonStats();
            } else if (mode === 'analysis') {
                this.elements.normalMode.style.display = 'block';
                this.elements.comparisonMode.style.display = 'none';
                document.querySelector('.stats-grid').style.display = 'grid';
                this.elements.advancedStats.style.display = 'block';
                this.elements.wordFrequency.style.display = this.state.settings.showWordFrequency ? 'block' : 'none';
                this.updateStats();
            }
        }

        updateComparisonStats() {
            const textA = this.elements.inputA.value;
            const textB = this.elements.inputB.value;
            
            // テキストAの統計
            const statsA = this.calculateBasicStats(textA);
            document.getElementById('charsA').textContent = statsA.chars.toLocaleString();
            document.getElementById('wordsA').textContent = statsA.words.toLocaleString();
            document.getElementById('linesA').textContent = statsA.lines.toLocaleString();
            
            // テキストBの統計
            const statsB = this.calculateBasicStats(textB);
            document.getElementById('charsB').textContent = statsB.chars.toLocaleString();
            document.getElementById('wordsB').textContent = statsB.words.toLocaleString();
            document.getElementById('linesB').textContent = statsB.lines.toLocaleString();
            
            // 比較結果
            const charDiff = Math.abs(statsA.chars - statsB.chars);
            const wordDiff = Math.abs(statsA.words - statsB.words);
            
            document.getElementById('charDiff').textContent = charDiff.toLocaleString();
            document.getElementById('wordDiff').textContent = wordDiff.toLocaleString();
            
            // 共通語句の計算
            const wordsA = new Set(statsA.wordList.map(w => w.toLowerCase()));
            const wordsB = new Set(statsB.wordList.map(w => w.toLowerCase()));
            const commonWords = [...wordsA].filter(x => wordsB.has(x)).length;
            document.getElementById('commonWords').textContent = commonWords.toLocaleString();
            
            // 類似度の計算（Jaccard係数）
            const union = new Set([...wordsA, ...wordsB]);
            const similarity = union.size > 0 ? Math.round((commonWords / union.size) * 100) : 0;
            document.getElementById('similarity').textContent = similarity + '%';
            
            // 比較データを保存
            this.state.comparisonData = {
                textA: statsA,
                textB: statsB,
                commonWords,
                similarity
            };
        }

        calculateBasicStats(text) {
            const chars = text.length;
            const lines = text ? text.split('\n').length : 0;
            
            // 日本語判定と語数計算
            const hasJapanese = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/.test(text);
            let wordList = [];
            
            if (hasJapanese) {
                wordList = this.tokenizeJapanese(text);
            } else {
                wordList = text.match(/\S+/g) || [];
            }
            
            return {
                chars,
                words: wordList.length,
                lines,
                wordList
            };
        }

        copyText() {
            let text = '';
            if (this.state.mode === 'comparison') {
                // 比較モードの場合は両方のテキストをコピー
                text = `【テキストA】\n${this.elements.inputA.value}\n\n【テキストB】\n${this.elements.inputB.value}`;
            } else {
                text = this.elements.input.value;
            }
            
            if (text) {
                // navigator.clipboard.writeTextを使う
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text)
                        .then(() => {
                            this.showToast('テキストをコピーしました');
                        })
                        .catch((err) => {
                            // フォールバック
                            this.fallbackCopy(text);
                        });
                } else {
                    // フォールバック
                    this.fallbackCopy(text);
                }
            }
        }

        fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'absolute';
            textarea.style.left = '-9999px';
            document.body.appendChild(textarea);
            textarea.select();
            
            try {
                document.execCommand('copy');
                this.showToast('テキストをコピーしました');
            } catch (err) {
                this.showToast('コピーに失敗しました');
            }
            
            document.body.removeChild(textarea);
        }

        showToast(message, duration = 3000) {
            this.elements.toast.textContent = message;
            this.elements.toast.classList.add('show');
            setTimeout(() => {
                this.elements.toast.classList.remove('show');
            }, duration);
        }

        reset() {
            if (confirm('すべての内容をリセットしますか？')) {
                if (this.state.mode === 'comparison') {
                    this.elements.inputA.value = '';
                    this.elements.inputB.value = '';
                    this.updateComparisonStats();
                } else {
                    this.elements.input.value = '';
                    this.updateStats();
                }
                this.showToast('リセットしました');
            }
        }

        getLastAnalysis() {
            return this.state.lastAnalysis;
        }

        exportAsText() {
            const stats = this.getLastAnalysis();
            if (!stats) {
                this.showToast('分析するテキストがありません');
                return;
            }
            
            const content = `文字数カウンター分析結果
========================
分析日時: ${new Date(stats.timestamp).toLocaleString()}

【基本統計】
総文字数: ${stats.totalChars.toLocaleString()}
文字数（空白除く）: ${stats.charsNoSpaces.toLocaleString()}
単語数: ${stats.wordCount.toLocaleString()}
行数: ${stats.lines.toLocaleString()}
段落数: ${stats.paragraphs.toLocaleString()}
文数: ${stats.sentenceCount.toLocaleString()}

【テキスト内容】
${stats.text}`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `character_count_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('テキストファイルをエクスポートしました');
        }

        exportAsJSON() {
            const stats = this.getLastAnalysis();
            if (!stats) {
                this.showToast('分析するテキストがありません');
                return;
            }
            
            const blob = new Blob([JSON.stringify(stats, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `character_count_${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('JSONファイルをエクスポートしました');
        }

        exportAsCSV() {
            const stats = this.getLastAnalysis();
            if (!stats) {
                this.showToast('分析するテキストがありません');
                return;
            }
            
            const csv = `項目,値
分析日時,${new Date(stats.timestamp).toLocaleString()}
総文字数,${stats.totalChars}
文字数（空白除く）,${stats.charsNoSpaces}
単語数,${stats.wordCount}
行数,${stats.lines}
段落数,${stats.paragraphs}
文数,${stats.sentenceCount}`;
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `character_count_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            this.showToast('CSVファイルをエクスポートしました');
        }
    }

    // アプリケーションを初期化
    const characterCounter = new CharacterCounter();
  </script>
</body>

</html>
